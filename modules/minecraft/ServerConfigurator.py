"""
ë§ˆì¸í¬ë˜í”„íŠ¸ ì„œë²„ ìë™ ì„¤ì • ë° ì´ˆê¸°í™”
ê²½ë¡œ: modules/minecraft/ServerConfigurator.py
"""

import json
import secrets
import re
from pathlib import Path
from typing import Tuple, Optional


class ServerConfigurator:
    """ì„œë²„ ìë™ ì„¤ì • ê´€ë¦¬"""
    
    BOT_CONFIG_FILE = "bot_config.json"
    
    def __init__(self, default_min_memory: int, default_max_memory: int):
        """
        Args:
            default_min_memory: ê¸°ë³¸ ìµœì†Œ ë©”ëª¨ë¦¬ (MB)
            default_max_memory: ê¸°ë³¸ ìµœëŒ€ ë©”ëª¨ë¦¬ (MB)
        """
        self.default_min_memory = default_min_memory
        self.default_max_memory = default_max_memory
    
    def scan_server_folder(self, server_path: Path) -> Tuple[bool, str, Optional[dict]]:
        """
        ì„œë²„ í´ë”ë¥¼ ìŠ¤ìº”í•˜ì—¬ ì •ë³´ ìˆ˜ì§‘
        
        Returns:
            (ìœ íš¨í•œ í´ë”ì¸ì§€, ë©”ì‹œì§€, ì„œë²„ ì •ë³´)
        """
        if not server_path.exists():
            return False, "í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", None
        
        if not server_path.is_dir():
            return False, "í´ë”ê°€ ì•„ë‹™ë‹ˆë‹¤.", None
        
        # server.jar ì°¾ê¸°
        jar_files = list(server_path.glob("*.jar"))
        
        if not jar_files:
            return False, "ì„œë²„ jar íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", None
        
        # ì„œë²„ jar íŒŒì¼ ì„ íƒ (server.jar ìš°ì„ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸)
        server_jar = None
        for jar in jar_files:
            if jar.name.lower() == "server.jar":
                server_jar = jar
                break
        
        if not server_jar:
            server_jar = jar_files[0]
        
        info = {
            "jar_file": server_jar.name,
            "has_world": (server_path / "world").exists(),
            "has_eula": (server_path / "eula.txt").exists(),
            "has_properties": (server_path / "server.properties").exists(),
            "has_bot_config": (server_path / self.BOT_CONFIG_FILE).exists()
        }
        
        return True, "ì„œë²„ í´ë”ê°€ ìœ íš¨í•©ë‹ˆë‹¤.", info
    
    def load_bot_config(self, server_path: Path) -> dict:
        """
        bot_config.json ë¡œë“œ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ìƒì„±)
        
        Returns:
            ì„œë²„ ì„¤ì • ë”•ì…”ë„ˆë¦¬
        """
        config_file = server_path / self.BOT_CONFIG_FILE
        
        if config_file.exists():
            try:
                with open(config_file, 'r', encoding='utf-8') as f:
                    config = json.load(f)
                print(f"âœ… ë´‡ ì„¤ì • ë¡œë“œ: {server_path.name}")
                return config
            except Exception as e:
                print(f"âš ï¸ ë´‡ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©: {e}")
        
        # ê¸°ë³¸ ì„¤ì • ìƒì„±
        config = {
            "memory": {
                "min": self.default_min_memory,
                "max": self.default_max_memory
            },
            "rcon": {
                "port": 25575,
                "auto_password": True  # ìë™ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
            },
            "description": ""
        }
        
        # ì €ì¥
        self.save_bot_config(server_path, config)
        print(f"âœ… ë´‡ ì„¤ì • ìƒì„±: {server_path.name}")
        
        return config
    
    def save_bot_config(self, server_path: Path, config: dict):
        """bot_config.json ì €ì¥"""
        config_file = server_path / self.BOT_CONFIG_FILE
        
        try:
            with open(config_file, 'w', encoding='utf-8') as f:
                json.dump(config, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"âŒ ë´‡ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: {e}")
    
    def generate_rcon_password(self, length: int = 16) -> str:
        """ì•ˆì „í•œ RCON ë¹„ë°€ë²ˆí˜¸ ìƒì„±"""
        # ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•©
        alphabet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*"
        password = ''.join(secrets.choice(alphabet) for _ in range(length))
        return password
    
    def setup_eula(self, server_path: Path) -> Tuple[bool, str]:
        """
        eula.txt ìë™ ì„¤ì •
        
        Returns:
            (ì„±ê³µ ì—¬ë¶€, ë©”ì‹œì§€)
        """
        eula_file = server_path / "eula.txt"
        
        try:
            # íŒŒì¼ì´ ìˆìœ¼ë©´ ì½ê¸°
            if eula_file.exists():
                with open(eula_file, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # ì´ë¯¸ trueë©´ ìŠ¤í‚µ
                if 'eula=true' in content:
                    return True, "EULAê°€ ì´ë¯¸ ë™ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
                
                # falseë¥¼ trueë¡œ ë³€ê²½
                content = re.sub(r'eula=false', 'eula=true', content)
            else:
                # íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                content = (
                    "# By changing the setting below to TRUE you are indicating your agreement to our EULA (https://aka.ms/MinecraftEULA).\n"
                    "# Generated by Discord Bot\n"
                    "eula=true\n"
                )
            
            # ì €ì¥
            with open(eula_file, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"âœ… EULA ë™ì˜ ì™„ë£Œ: {server_path.name}")
            return True, "EULAê°€ ìë™ìœ¼ë¡œ ë™ì˜ë˜ì—ˆìŠµë‹ˆë‹¤."
            
        except Exception as e:
            print(f"âŒ EULA ì„¤ì • ì‹¤íŒ¨: {e}")
            return False, f"EULA ì„¤ì • ì˜¤ë¥˜: {e}"
    
    def setup_rcon(self, server_path: Path, rcon_port: int, rcon_password: str) -> Tuple[bool, str]:
        """
        server.propertiesì— RCON ì„¤ì • ì¶”ê°€/ìˆ˜ì •
        
        Returns:
            (ì„±ê³µ ì—¬ë¶€, ë©”ì‹œì§€)
        """
        properties_file = server_path / "server.properties"
        
        try:
            # íŒŒì¼ ì½ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
            if properties_file.exists():
                with open(properties_file, 'r', encoding='utf-8') as f:
                    lines = f.readlines()
            else:
                lines = []
            
            # RCON ì„¤ì • ì—…ë°ì´íŠ¸
            rcon_settings = {
                'enable-rcon': 'true',
                'rcon.port': str(rcon_port),
                'rcon.password': rcon_password
            }
            
            # ê¸°ì¡´ ë¼ì¸ ìˆ˜ì • ë˜ëŠ” ì¶”ê°€
            updated_lines = []
            found_keys = set()
            
            for line in lines:
                line = line.strip()
                
                # ì£¼ì„ì´ë‚˜ ë¹ˆ ì¤„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
                if not line or line.startswith('#'):
                    updated_lines.append(line)
                    continue
                
                # key=value íŒŒì‹±
                if '=' in line:
                    key = line.split('=')[0].strip()
                    
                    # RCON ê´€ë ¨ ì„¤ì •ì´ë©´ ì—…ë°ì´íŠ¸
                    if key in rcon_settings:
                        updated_lines.append(f"{key}={rcon_settings[key]}")
                        found_keys.add(key)
                    else:
                        updated_lines.append(line)
                else:
                    updated_lines.append(line)
            
            # ì—†ì—ˆë˜ ì„¤ì • ì¶”ê°€
            if not found_keys:
                updated_lines.append("")
                updated_lines.append("# RCON Settings (Auto-generated by Bot)")
            
            for key, value in rcon_settings.items():
                if key not in found_keys:
                    updated_lines.append(f"{key}={value}")
            
            # ì €ì¥
            with open(properties_file, 'w', encoding='utf-8') as f:
                f.write('\n'.join(updated_lines))
            
            print(f"âœ… RCON ì„¤ì • ì™„ë£Œ: {server_path.name}")
            return True, f"RCONì´ í¬íŠ¸ {rcon_port}ì— ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
            
        except Exception as e:
            print(f"âŒ RCON ì„¤ì • ì‹¤íŒ¨: {e}")
            return False, f"RCON ì„¤ì • ì˜¤ë¥˜: {e}"
    
    def get_server_port(self, server_path: Path) -> int:
        """server.propertiesì—ì„œ í¬íŠ¸ ì½ê¸°"""
        properties_file = server_path / "server.properties"
        
        if not properties_file.exists():
            return 25565  # ê¸°ë³¸ í¬íŠ¸
        
        try:
            with open(properties_file, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line.startswith('server-port='):
                        port = line.split('=')[1].strip()
                        return int(port)
        except:
            pass
        
        return 25565  # ê¸°ë³¸ í¬íŠ¸
    
    def _read_rcon_password(self, server_path: Path) -> Optional[str]:
        """
        server.propertiesì—ì„œ ê¸°ì¡´ RCON ë¹„ë°€ë²ˆí˜¸ ì½ê¸°
        
        Returns:
            ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” None
        """
        properties_file = server_path / "server.properties"
        
        if not properties_file.exists():
            return None
        
        try:
            with open(properties_file, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line.startswith('rcon.password='):
                        password = line.split('=', 1)[1].strip()
                        if password:  # ë¹„ì–´ìˆì§€ ì•Šì€ ë¹„ë°€ë²ˆí˜¸ë§Œ
                            return password
        except Exception as e:
            print(f"âš ï¸ RCON ë¹„ë°€ë²ˆí˜¸ ì½ê¸° ì‹¤íŒ¨: {e}")
        
        return None
    
    def prepare_server(self, server_path: Path) -> Tuple[bool, str, dict]:
        """
        ì„œë²„ ìµœì´ˆ ì‹¤í–‰ ì „ ëª¨ë“  ì„¤ì • ìë™í™”
        
        1. bot_config.json ë¡œë“œ/ìƒì„±
        2. EULA ë™ì˜
        3. RCON ë¹„ë°€ë²ˆí˜¸ ìƒì„± ë° ì„¤ì •
        
        Returns:
            (ì„±ê³µ ì—¬ë¶€, ë©”ì‹œì§€, ì„œë²„ ì„¤ì •)
        """
        print(f"\nğŸ”§ ì„œë²„ ì„¤ì • ì¤‘: {server_path.name}")
        
        # 1. ì„œë²„ í´ë” ê²€ì¦
        valid, message, info = self.scan_server_folder(server_path)
        if not valid:
            return False, message, {}
        
        # 2. ë´‡ ì„¤ì • ë¡œë“œ
        bot_config = self.load_bot_config(server_path)
        
        # 3. EULA ë™ì˜
        success, eula_msg = self.setup_eula(server_path)
        if not success:
            return False, eula_msg, {}
        
        # 4. RCON ë¹„ë°€ë²ˆí˜¸ ì²˜ë¦¬ (âœ… ìˆ˜ì •ëœ ë¶€ë¶„)
        rcon_port = bot_config['rcon'].get('port', 25575)
        
        # âœ… server.propertiesì—ì„œ ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì½ê¸° ì‹œë„
        existing_password = self._read_rcon_password(server_path)
        
        if existing_password:
            # ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš© (ì„œë²„ê°€ ì´ë¯¸ ì„¤ì •ë¨)
            rcon_password = existing_password
            print(f"   ğŸ”‘ ê¸°ì¡´ RCON ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©")
        elif bot_config['rcon'].get('auto_password', True):
            # ìƒˆ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
            rcon_password = self.generate_rcon_password()
            print(f"   ğŸ”‘ ìƒˆ RCON ë¹„ë°€ë²ˆí˜¸ ìƒì„±")
        else:
            # ì„¤ì • íŒŒì¼ì—ì„œ ì§€ì •ëœ ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©
            rcon_password = bot_config['rcon'].get('password', self.generate_rcon_password())
            print(f"   ğŸ”‘ ì„¤ì •ëœ RCON ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©")
        
        # 5. RCON ì„¤ì •
        success, rcon_msg = self.setup_rcon(server_path, rcon_port, rcon_password)
        if not success:
            return False, rcon_msg, {}
        
        # 6. ì„œë²„ í¬íŠ¸ ì½ê¸°
        server_port = self.get_server_port(server_path)
        
        # 7. ì„œë²„ ì„¤ì • ë°˜í™˜
        server_config = {
            "name": server_path.name.replace('_', ' ').title(),
            "path": str(server_path),
            "jar_file": info['jar_file'],
            "memory": {
                "min": bot_config['memory']['min'],
                "max": bot_config['memory']['max']
            },
            "port": server_port,
            "rcon": {
                "enabled": True,
                "host": "localhost",
                "port": rcon_port,
                "password": rcon_password
            },
            "description": bot_config.get('description', ''),
            "is_new": not info['has_world']  # world í´ë”ê°€ ì—†ìœ¼ë©´ ì‹ ê·œ
        }
        
        print(f"âœ… ì„œë²„ ì„¤ì • ì™„ë£Œ: {server_path.name}")
        print(f"   - ë©”ëª¨ë¦¬: {server_config['memory']['min']}MB ~ {server_config['memory']['max']}MB")
        print(f"   - í¬íŠ¸: {server_config['port']}")
        print(f"   - RCON: {server_config['rcon']['port']} (ë¹„ë°€ë²ˆí˜¸: {'ê¸°ì¡´' if existing_password else 'ì‹ ê·œ'})")
        
        return True, "ì„œë²„ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", server_config